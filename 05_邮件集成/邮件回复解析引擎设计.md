# é‚®ä»¶å›å¤è§£æå¼•æ“è®¾è®¡

## ç³»ç»Ÿæ¶æ„æ¦‚è§ˆ

### è§£æå¼•æ“ç»„ä»¶
- **é‚®ä»¶ç›‘å¬æœåŠ¡**: ç›‘æ§Outlooké‚®ç®±ä¸­çš„æ–°é‚®ä»¶
- **å†…å®¹è§£æå™¨**: è§£æé‚®ä»¶ä¸»é¢˜å’Œæ­£æ–‡å†…å®¹
- **å†³ç­–è¯†åˆ«å™¨**: åˆ¤æ–­å®¡æ‰¹ç»“æœï¼ˆåŒæ„/æ‹’ç»/å…¶ä»–ï¼‰
- **æ•°æ®æå–å™¨**: æå–å®¡æ‰¹æ„è§å’Œç›¸å…³ä¿¡æ¯
- **ç»“æœå¤„ç†å™¨**: æ›´æ–°æ•°æ®åº“å¹¶è§¦å‘åç»­æµç¨‹

## 1. é‚®ä»¶ç›‘å¬é…ç½®

### Power Automateè§¦å‘å™¨
```json
{
  "type": "Office365WhenANewEmailArrives",
  "inputs": {
    "parameters": {
      "folderPath": "Inbox",
      "to": "approval-system@company.com",
      "subjectFilter": "APPROVE-|REJECT-|REQ",
      "importance": "Any",
      "includeAttachments": false,
      "onlyWithAttachment": false
    }
  },
  "conditions": {
    "triggerConditions": [
      "@contains(triggerBody()['Subject'], 'REQ')",
      "@or(contains(upper(triggerBody()['Subject']), 'APPROVE'), contains(upper(triggerBody()['Subject']), 'REJECT'))"
    ]
  }
}
```

### é‚®ä»¶ç­›é€‰è§„åˆ™
```json
{
  "EmailFilterRules": {
    "SubjectPatterns": [
      "^(APPROVE|REJECT)-REQ\\d{8}\\d{4}$",
      "^Re:.*ã€æƒé™å®¡æ‰¹ã€‘.*REQ\\d{8}\\d{4}",
      "^å›å¤:.*æƒé™ç”³è¯·.*REQ\\d{8}\\d{4}"
    ],
    "SenderValidation": {
      "AllowedDomains": ["company.com", "partner.com"],
      "ReviewerListCheck": true,
      "BlockedSenders": []
    },
    "ContentRequirements": {
      "MinLength": 10,
      "MaxLength": 5000,
      "RequiredElements": ["RequestID", "Decision"]
    }
  }
}
```

## 2. ä¸»é¢˜è¡Œè§£æå™¨

### ç”³è¯·ç¼–å·æå–
```javascript
// Power Automate Expression
@{
  if(
    contains(triggerBody()['Subject'], 'REQ'),
    first(
      split(
        last(
          split(triggerBody()['Subject'], 'REQ')
        ),
        ' '
      )
    ),
    ''
  )
}

// æ­£åˆ™è¡¨è¾¾å¼æ¨¡å¼
const requestIdPatterns = [
  /REQ(\d{8}\d{4})/g,           // REQ20240908001
  /ç”³è¯·ç¼–å·[ï¼š:]\s*(\d+)/g,      // ç”³è¯·ç¼–å·ï¼š20240908001
  /ç¼–å·[ï¼š:]\s*(REQ\d+)/g        // ç¼–å·ï¼šREQ20240908001
];
```

### å†³ç­–å…³é”®è¯è¯†åˆ«
```json
{
  "DecisionKeywords": {
    "Approve": {
      "Chinese": ["åŒæ„", "æ‰¹å‡†", "é€šè¿‡", "å¯ä»¥", "å…è®¸", "èµæˆ", "æ”¯æŒ"],
      "English": ["APPROVE", "APPROVED", "YES", "ACCEPT", "AGREED", "OK"],
      "Symbols": ["âœ“", "âˆš", "ğŸ‘"],
      "Patterns": [
        "^\\s*(åŒæ„|æ‰¹å‡†|é€šè¿‡)",
        "APPROVE-REQ\\d+",
        "å®¡æ‰¹ç»“æœ[ï¼š:]\\s*(åŒæ„|é€šè¿‡)"
      ]
    },
    "Reject": {
      "Chinese": ["æ‹’ç»", "é©³å›", "ä¸åŒæ„", "ä¸æ‰¹å‡†", "ä¸é€šè¿‡", "åå¯¹"],
      "English": ["REJECT", "REJECTED", "NO", "DENY", "DENIED", "REFUSE"],
      "Symbols": ["âœ—", "Ã—", "ğŸ‘"],
      "Patterns": [
        "^\\s*(æ‹’ç»|é©³å›|ä¸åŒæ„)",
        "REJECT-REQ\\d+",
        "å®¡æ‰¹ç»“æœ[ï¼š:]\\s*(æ‹’ç»|é©³å›)"
      ]
    },
    "Uncertain": {
      "Keywords": ["éœ€è¦æ›´å¤šä¿¡æ¯", "ä¸ç¡®å®š", "å¾…å®š", "éœ€è¦è®¨è®º"],
      "Patterns": ["éœ€è¦.*ä¿¡æ¯", "ä¸å¤ªç¡®å®š", "å»ºè®®.*è®¨è®º"]
    }
  }
}
```

## 3. é‚®ä»¶å†…å®¹è§£æå™¨

### HTMLé‚®ä»¶å†…å®¹æ¸…ç†
```json
{
  "type": "Compose",
  "inputs": "@replace(replace(replace(replace(triggerBody()['Body'], '<[^>]*>', ''), '&nbsp;', ' '), '&lt;', '<'), '&gt;', '>')",
  "runAfter": {
    "é‚®ä»¶æ¥æ”¶è§¦å‘": ["Succeeded"]
  }
}
```

### ç»“æ„åŒ–å†…å®¹æå–
```javascript
// Power Automateè¡¨è¾¾å¼ç»„åˆ
{
  "ExtractedContent": {
    "RequestID": "@outputs('æå–ç”³è¯·ç¼–å·')",
    "Decision": "@outputs('è¯†åˆ«å†³ç­–ç±»å‹')",
    "Comments": "@outputs('æå–å®¡æ‰¹æ„è§')",
    "ReviewerEmail": "@triggerBody()['From']",
    "ReviewDate": "@utcNow()",
    "OriginalSubject": "@triggerBody()['Subject']",
    "OriginalBody": "@outputs('æ¸…ç†é‚®ä»¶å†…å®¹')"
  }
}
```

### å®¡æ‰¹æ„è§æå–ç®—æ³•
```json
{
  "type": "Switch",
  "expression": "@outputs('è¯†åˆ«å†³ç­–ç±»å‹')",
  "cases": {
    "Approved": {
      "case": "APPROVE",
      "actions": {
        "æå–åŒæ„æ„è§": {
          "type": "Compose",
          "inputs": "@{
            // æŸ¥æ‰¾"å®¡æ‰¹æ„è§"ã€"åŒæ„ç†ç”±"ç­‰å…³é”®è¯åçš„å†…å®¹
            first(
              split(
                last(
                  split(outputs('æ¸…ç†é‚®ä»¶å†…å®¹'), 'å®¡æ‰¹æ„è§')
                ),
                '\n'
              )
            )
          }"
        }
      }
    },
    "Rejected": {
      "case": "REJECT", 
      "actions": {
        "æå–æ‹’ç»åŸå› ": {
          "type": "Compose",
          "inputs": "@{
            // æŸ¥æ‰¾"æ‹’ç»åŸå› "ã€"ä¸åŒæ„ç†ç”±"ç­‰å…³é”®è¯åçš„å†…å®¹
            coalesce(
              first(split(last(split(outputs('æ¸…ç†é‚®ä»¶å†…å®¹'), 'æ‹’ç»åŸå› ')), '\n')),
              first(split(last(split(outputs('æ¸…ç†é‚®ä»¶å†…å®¹'), 'ä¸åŒæ„ç†ç”±')), '\n')),
              'æœªæä¾›å…·ä½“åŸå› '
            )
          }"
        }
      }
    }
  },
  "default": {
    "actions": {
      "æå–ä¸€èˆ¬æ„è§": {
        "type": "Compose",
        "inputs": "@take(outputs('æ¸…ç†é‚®ä»¶å†…å®¹'), 200)"
      }
    }
  }
}
```

## 4. æ™ºèƒ½å†³ç­–è¯†åˆ«

### å¤šå±‚æ¬¡å†³ç­–åˆ¤æ–­
```json
{
  "DecisionLogic": {
    "Priority1_SubjectLine": {
      "Description": "ä¸»é¢˜è¡Œæ˜ç¡®æ ‡è¯†",
      "Patterns": ["APPROVE-REQ", "REJECT-REQ"],
      "Confidence": 0.95
    },
    "Priority2_FirstLine": {
      "Description": "é‚®ä»¶æ­£æ–‡ç¬¬ä¸€è¡Œ",
      "Patterns": ["^\\s*(åŒæ„|æ‹’ç»|æ‰¹å‡†|é©³å›)"],
      "Confidence": 0.90
    },
    "Priority3_Keywords": {
      "Description": "å…³é”®è¯åŒ¹é…",
      "Method": "æƒé‡è®¡ç®—",
      "Confidence": 0.75
    },
    "Priority4_Context": {
      "Description": "ä¸Šä¸‹æ–‡åˆ†æ",  
      "Method": "è¯­ä¹‰åˆ†æ",
      "Confidence": 0.60
    }
  }
}
```

### å†³ç­–ç½®ä¿¡åº¦è®¡ç®—
```javascript
// ç½®ä¿¡åº¦è®¡ç®—ç®—æ³•
function calculateConfidence(emailContent, keywords) {
  let approveScore = 0;
  let rejectScore = 0;
  
  // ä¸»é¢˜è¡Œæƒé‡ 40%
  if (subjectContainsApprove) approveScore += 40;
  if (subjectContainsReject) rejectScore += 40;
  
  // ç¬¬ä¸€æ®µæƒé‡ 30%
  if (firstParagraphIndicatesApprove) approveScore += 30;
  if (firstParagraphIndicatesReject) rejectScore += 30;
  
  // å…³é”®è¯æƒé‡ 20%
  approveScore += countApproveKeywords() * 2;
  rejectScore += countRejectKeywords() * 2;
  
  // ä¸Šä¸‹æ–‡æƒé‡ 10%
  approveScore += contextAnalysis.approve * 10;
  rejectScore += contextAnalysis.reject * 10;
  
  return {
    decision: approveScore > rejectScore ? 'APPROVE' : 'REJECT',
    confidence: Math.max(approveScore, rejectScore) / 100
  };
}
```

## 5. æ•°æ®éªŒè¯å’Œæ¸…æ´—

### å®¡æ ¸äººèº«ä»½éªŒè¯
```json
{
  "type": "SharePointGetItems",
  "inputs": {
    "parameters": {
      "site": "@parameters('SharePointSiteUrl')",
      "list": "ReviewerConfig", 
      "query": {
        "filter": "ReviewerEmail eq '@{triggerBody()['From']}' and IsActive eq true"
      }
    }
  },
  "description": "éªŒè¯å‘ä»¶äººæ˜¯å¦ä¸ºæˆæƒå®¡æ ¸äºº"
}
```

### ç”³è¯·çŠ¶æ€æ£€æŸ¥
```json
{
  "type": "SharePointGetItems",
  "inputs": {
    "parameters": {
      "site": "@parameters('SharePointSiteUrl')",
      "list": "PermissionRequests",
      "query": {
        "filter": "RequestID eq '@{variables('ExtractedRequestID')}' and Status eq 'å·²å‘é€å®¡æ‰¹é‚®ä»¶'"
      }
    }
  },
  "description": "ç¡®è®¤ç”³è¯·ä»å¤„äºå¾…å®¡æ‰¹çŠ¶æ€"
}
```

### é‡å¤å¤„ç†é˜²æŠ¤
```json
{
  "type": "SharePointGetItems",
  "inputs": {
    "parameters": {
      "site": "@parameters('SharePointSiteUrl')",
      "list": "ApprovalHistory",
      "query": {
        "filter": "RequestID eq '@{variables('ExtractedRequestID')}' and ReviewerEmail eq '@{triggerBody()['From']}'"
      }
    }
  },
  "description": "æ£€æŸ¥è¯¥å®¡æ ¸äººæ˜¯å¦å·²ç»å®¡æ‰¹è¿‡æ­¤ç”³è¯·"
}
```

## 6. å¼‚å¸¸å¤„ç†æœºåˆ¶

### è§£æå¤±è´¥å¤„ç†
```json
{
  "type": "Condition",
  "expression": {
    "or": [
      "@empty(variables('ExtractedRequestID'))",
      "@equals(variables('DecisionConfidence'), 0)",
      "@empty(body('éªŒè¯å®¡æ ¸äººèº«ä»½')?['value'])"
    ]
  },
  "actions": {
    "å‘é€è§£æå¤±è´¥é€šçŸ¥": {
      "type": "Office365SendEmail",
      "inputs": {
        "parameters": {
          "To": "@triggerBody()['From']",
          "CC": "@parameters('SystemAdminEmail')",
          "Subject": "ã€ç³»ç»Ÿæç¤ºã€‘é‚®ä»¶å®¡æ‰¹æ ¼å¼ä¸æ­£ç¡®",
          "Body": "æ‚¨çš„å®¡æ‰¹é‚®ä»¶æ ¼å¼ä¸æ­£ç¡®ï¼Œè¯·æŒ‰ç…§ä»¥ä¸‹æ ¼å¼é‡æ–°å‘é€...",
          "IsHtml": true
        }
      }
    },
    "è®°å½•è§£æé”™è¯¯": {
      "type": "SharePointCreateItem",
      "inputs": {
        "parameters": {
          "site": "@parameters('SharePointSiteUrl')",
          "list": "EmailParsingErrors",
          "item": {
            "Title": "é‚®ä»¶è§£æå¤±è´¥",
            "SenderEmail": "@triggerBody()['From']",
            "Subject": "@triggerBody()['Subject']",
            "Body": "@triggerBody()['Body']",
            "ErrorReason": "@outputs('è§£æé”™è¯¯åˆ†æ')",
            "ReceivedTime": "@utcNow()"
          }
        }
      }
    }
  }
}
```

### æ¨¡ç³Šå†³ç­–å¤„ç†
```json
{
  "type": "Condition", 
  "expression": {
    "less": ["@variables('DecisionConfidence')", 0.7]
  },
  "actions": {
    "äººå·¥ç¡®è®¤æµç¨‹": {
      "type": "Office365SendEmail",
      "inputs": {
        "parameters": {
          "To": "@triggerBody()['From']",
          "Subject": "ã€éœ€è¦ç¡®è®¤ã€‘å®¡æ‰¹æ„è§ä¸å¤Ÿæ˜ç¡®",
          "Body": "ç³»ç»Ÿæ— æ³•ç¡®å®šæ‚¨çš„å®¡æ‰¹æ„è§ï¼Œè¯·å›å¤ä»¥ä¸‹é€‰é¡¹ä¹‹ä¸€ï¼š\n1. è¾“å…¥'APPROVE-@{variables('ExtractedRequestID')}'è¡¨ç¤ºåŒæ„\n2. è¾“å…¥'REJECT-@{variables('ExtractedRequestID')}'è¡¨ç¤ºæ‹’ç»"
        }
      }
    },
    "æ ‡è®°å¾…ç¡®è®¤": {
      "type": "SharePointCreateItem",
      "inputs": {
        "parameters": {
          "site": "@parameters('SharePointSiteUrl')",
          "list": "PendingConfirmation",
          "item": {
            "RequestID": "@variables('ExtractedRequestID')",
            "ReviewerEmail": "@triggerBody()['From']",
            "OriginalContent": "@triggerBody()['Body']",
            "Confidence": "@variables('DecisionConfidence')",
            "Status": "å¾…äººå·¥ç¡®è®¤"
          }
        }
      }
    }
  }
}
```

## 7. ç»“æœå¤„ç†å’Œæ›´æ–°

### æ›´æ–°ç”³è¯·çŠ¶æ€
```json
{
  "type": "SharePointUpdateItem",
  "inputs": {
    "parameters": {
      "site": "@parameters('SharePointSiteUrl')",
      "list": "PermissionRequests",
      "id": "@body('è·å–ç”³è¯·ä¿¡æ¯')?['value'][0]?['ID']",
      "item": {
        "Status": {
          "Value": "@if(equals(variables('FinalDecision'), 'APPROVE'), 'å®¡æ‰¹é€šè¿‡', 'å®¡æ‰¹æ‹’ç»')"
        },
        "ReviewDate": "@utcNow()",
        "Comments": "@variables('ExtractedComments')",
        "ReviewedBy": "@triggerBody()['From']"
      }
    }
  }
}
```

### åˆ›å»ºå®¡æ‰¹å†å²è®°å½•
```json
{
  "type": "SharePointCreateItem",
  "inputs": {
    "parameters": {
      "site": "@parameters('SharePointSiteUrl')",
      "list": "ApprovalHistory",
      "item": {
        "Title": "@concat(variables('ExtractedRequestID'), '-', formatDateTime(utcNow(), 'yyyyMMddHHmm'))",
        "RequestID": "@variables('ExtractedRequestID')",
        "ReviewerEmail": "@triggerBody()['From']",
        "Decision": "@variables('FinalDecision')",
        "Comments": "@variables('ExtractedComments')",
        "ReviewDate": "@utcNow()",
        "Source": "Email",
        "Confidence": "@variables('DecisionConfidence')",
        "OriginalSubject": "@triggerBody()['Subject']"
      }
    }
  }
}
```

## 8. é€šçŸ¥åé¦ˆæœºåˆ¶

### å®¡æ‰¹ç¡®è®¤é‚®ä»¶
```json
{
  "type": "Office365SendEmail",
  "inputs": {
    "parameters": {
      "To": "@triggerBody()['From']",
      "CC": "@body('è·å–ç”³è¯·ä¿¡æ¯')?['value'][0]?['ApplicantEmail']",
      "Subject": "ã€å®¡æ‰¹ç¡®è®¤ã€‘æ‚¨çš„å®¡æ‰¹å·²å¤„ç† - @{variables('ExtractedRequestID')}",
      "Body": "æ„Ÿè°¢æ‚¨çš„å®¡æ‰¹ï¼\nç”³è¯·ç¼–å·ï¼š@{variables('ExtractedRequestID')}\nå®¡æ‰¹ç»“æœï¼š@{if(equals(variables('FinalDecision'), 'APPROVE'), 'åŒæ„', 'æ‹’ç»')}\nå¤„ç†æ—¶é—´ï¼š@{formatDateTime(utcNow(), 'yyyyå¹´MMæœˆddæ—¥ HH:mm')}\n\nç³»ç»Ÿå·²è‡ªåŠ¨æ›´æ–°ç”³è¯·çŠ¶æ€ã€‚",
      "IsHtml": false
    }
  }
}
```

### ç”³è¯·äººç»“æœé€šçŸ¥
```json
{
  "type": "CallPowerAutomateFlow",
  "inputs": {
    "parameters": {
      "FlowName": "SendApprovalResultNotification",
      "RequestID": "@variables('ExtractedRequestID')",
      "Decision": "@variables('FinalDecision')",
      "Comments": "@variables('ExtractedComments')",
      "ReviewerName": "@body('è·å–å®¡æ ¸äººä¿¡æ¯')?['value'][0]?['ReviewerName']"
    }
  }
}
```

## 9. æ€§èƒ½ç›‘æ§å’Œç»Ÿè®¡

### è§£ææˆåŠŸç‡ç»Ÿè®¡
```json
{
  "type": "SharePointCreateItem",
  "inputs": {
    "parameters": {
      "site": "@parameters('SharePointSiteUrl')",
      "list": "EmailProcessingStats",
      "item": {
        "Title": "@formatDateTime(utcNow(), 'yyyyMMdd-HHmmss')",
        "ProcessingDate": "@utcNow()",
        "SenderEmail": "@triggerBody()['From']",
        "RequestID": "@variables('ExtractedRequestID')",
        "DecisionFound": "@variables('FinalDecision')",
        "Confidence": "@variables('DecisionConfidence')",
        "ProcessingTimeMs": "@sub(ticks(utcNow()), ticks(variables('StartTime')))",
        "Status": "Success"
      }
    }
  }
}
```

### é”™è¯¯æ¨¡å¼åˆ†æ
```json
{
  "ErrorAnalytics": {
    "CommonFailureReasons": [
      "ç”³è¯·ç¼–å·æ ¼å¼ä¸æ­£ç¡®",
      "å†³ç­–å…³é”®è¯ä¸æ˜ç¡®", 
      "å‘ä»¶äººéæˆæƒå®¡æ ¸äºº",
      "ç”³è¯·å·²è¢«å¤„ç†",
      "é‚®ä»¶å†…å®¹ä¸ºç©º"
    ],
    "ImprovementSuggestions": [
      "æ›´æ–°é‚®ä»¶æ¨¡æ¿æŒ‡å¯¼",
      "æ‰©å……å…³é”®è¯è¯å…¸",
      "ä¼˜åŒ–è§£æç®—æ³•",
      "åŠ å¼ºç”¨æˆ·åŸ¹è®­"
    ]
  }
}
```