# 邮件回复解析引擎设计

## 系统架构概览

### 解析引擎组件
- **邮件监听服务**: 监控Outlook邮箱中的新邮件
- **内容解析器**: 解析邮件主题和正文内容
- **决策识别器**: 判断审批结果（同意/拒绝/其他）
- **数据提取器**: 提取审批意见和相关信息
- **结果处理器**: 更新数据库并触发后续流程

## 1. 邮件监听配置

### Power Automate触发器
```json
{
  "type": "Office365WhenANewEmailArrives",
  "inputs": {
    "parameters": {
      "folderPath": "Inbox",
      "to": "approval-system@company.com",
      "subjectFilter": "APPROVE-|REJECT-|REQ",
      "importance": "Any",
      "includeAttachments": false,
      "onlyWithAttachment": false
    }
  },
  "conditions": {
    "triggerConditions": [
      "@contains(triggerBody()['Subject'], 'REQ')",
      "@or(contains(upper(triggerBody()['Subject']), 'APPROVE'), contains(upper(triggerBody()['Subject']), 'REJECT'))"
    ]
  }
}
```

### 邮件筛选规则
```json
{
  "EmailFilterRules": {
    "SubjectPatterns": [
      "^(APPROVE|REJECT)-REQ\\d{8}\\d{4}$",
      "^Re:.*【权限审批】.*REQ\\d{8}\\d{4}",
      "^回复:.*权限申请.*REQ\\d{8}\\d{4}"
    ],
    "SenderValidation": {
      "AllowedDomains": ["company.com", "partner.com"],
      "ReviewerListCheck": true,
      "BlockedSenders": []
    },
    "ContentRequirements": {
      "MinLength": 10,
      "MaxLength": 5000,
      "RequiredElements": ["RequestID", "Decision"]
    }
  }
}
```

## 2. 主题行解析器

### 申请编号提取
```javascript
// Power Automate Expression
@{
  if(
    contains(triggerBody()['Subject'], 'REQ'),
    first(
      split(
        last(
          split(triggerBody()['Subject'], 'REQ')
        ),
        ' '
      )
    ),
    ''
  )
}

// 正则表达式模式
const requestIdPatterns = [
  /REQ(\d{8}\d{4})/g,           // REQ20240908001
  /申请编号[：:]\s*(\d+)/g,      // 申请编号：20240908001
  /编号[：:]\s*(REQ\d+)/g        // 编号：REQ20240908001
];
```

### 决策关键词识别
```json
{
  "DecisionKeywords": {
    "Approve": {
      "Chinese": ["同意", "批准", "通过", "可以", "允许", "赞成", "支持"],
      "English": ["APPROVE", "APPROVED", "YES", "ACCEPT", "AGREED", "OK"],
      "Symbols": ["✓", "√", "👍"],
      "Patterns": [
        "^\\s*(同意|批准|通过)",
        "APPROVE-REQ\\d+",
        "审批结果[：:]\\s*(同意|通过)"
      ]
    },
    "Reject": {
      "Chinese": ["拒绝", "驳回", "不同意", "不批准", "不通过", "反对"],
      "English": ["REJECT", "REJECTED", "NO", "DENY", "DENIED", "REFUSE"],
      "Symbols": ["✗", "×", "👎"],
      "Patterns": [
        "^\\s*(拒绝|驳回|不同意)",
        "REJECT-REQ\\d+",
        "审批结果[：:]\\s*(拒绝|驳回)"
      ]
    },
    "Uncertain": {
      "Keywords": ["需要更多信息", "不确定", "待定", "需要讨论"],
      "Patterns": ["需要.*信息", "不太确定", "建议.*讨论"]
    }
  }
}
```

## 3. 邮件内容解析器

### HTML邮件内容清理
```json
{
  "type": "Compose",
  "inputs": "@replace(replace(replace(replace(triggerBody()['Body'], '<[^>]*>', ''), '&nbsp;', ' '), '&lt;', '<'), '&gt;', '>')",
  "runAfter": {
    "邮件接收触发": ["Succeeded"]
  }
}
```

### 结构化内容提取
```javascript
// Power Automate表达式组合
{
  "ExtractedContent": {
    "RequestID": "@outputs('提取申请编号')",
    "Decision": "@outputs('识别决策类型')",
    "Comments": "@outputs('提取审批意见')",
    "ReviewerEmail": "@triggerBody()['From']",
    "ReviewDate": "@utcNow()",
    "OriginalSubject": "@triggerBody()['Subject']",
    "OriginalBody": "@outputs('清理邮件内容')"
  }
}
```

### 审批意见提取算法
```json
{
  "type": "Switch",
  "expression": "@outputs('识别决策类型')",
  "cases": {
    "Approved": {
      "case": "APPROVE",
      "actions": {
        "提取同意意见": {
          "type": "Compose",
          "inputs": "@{
            // 查找"审批意见"、"同意理由"等关键词后的内容
            first(
              split(
                last(
                  split(outputs('清理邮件内容'), '审批意见')
                ),
                '\n'
              )
            )
          }"
        }
      }
    },
    "Rejected": {
      "case": "REJECT", 
      "actions": {
        "提取拒绝原因": {
          "type": "Compose",
          "inputs": "@{
            // 查找"拒绝原因"、"不同意理由"等关键词后的内容
            coalesce(
              first(split(last(split(outputs('清理邮件内容'), '拒绝原因')), '\n')),
              first(split(last(split(outputs('清理邮件内容'), '不同意理由')), '\n')),
              '未提供具体原因'
            )
          }"
        }
      }
    }
  },
  "default": {
    "actions": {
      "提取一般意见": {
        "type": "Compose",
        "inputs": "@take(outputs('清理邮件内容'), 200)"
      }
    }
  }
}
```

## 4. 智能决策识别

### 多层次决策判断
```json
{
  "DecisionLogic": {
    "Priority1_SubjectLine": {
      "Description": "主题行明确标识",
      "Patterns": ["APPROVE-REQ", "REJECT-REQ"],
      "Confidence": 0.95
    },
    "Priority2_FirstLine": {
      "Description": "邮件正文第一行",
      "Patterns": ["^\\s*(同意|拒绝|批准|驳回)"],
      "Confidence": 0.90
    },
    "Priority3_Keywords": {
      "Description": "关键词匹配",
      "Method": "权重计算",
      "Confidence": 0.75
    },
    "Priority4_Context": {
      "Description": "上下文分析",  
      "Method": "语义分析",
      "Confidence": 0.60
    }
  }
}
```

### 决策置信度计算
```javascript
// 置信度计算算法
function calculateConfidence(emailContent, keywords) {
  let approveScore = 0;
  let rejectScore = 0;
  
  // 主题行权重 40%
  if (subjectContainsApprove) approveScore += 40;
  if (subjectContainsReject) rejectScore += 40;
  
  // 第一段权重 30%
  if (firstParagraphIndicatesApprove) approveScore += 30;
  if (firstParagraphIndicatesReject) rejectScore += 30;
  
  // 关键词权重 20%
  approveScore += countApproveKeywords() * 2;
  rejectScore += countRejectKeywords() * 2;
  
  // 上下文权重 10%
  approveScore += contextAnalysis.approve * 10;
  rejectScore += contextAnalysis.reject * 10;
  
  return {
    decision: approveScore > rejectScore ? 'APPROVE' : 'REJECT',
    confidence: Math.max(approveScore, rejectScore) / 100
  };
}
```

## 5. 数据验证和清洗

### 审核人身份验证
```json
{
  "type": "SharePointGetItems",
  "inputs": {
    "parameters": {
      "site": "@parameters('SharePointSiteUrl')",
      "list": "ReviewerConfig", 
      "query": {
        "filter": "ReviewerEmail eq '@{triggerBody()['From']}' and IsActive eq true"
      }
    }
  },
  "description": "验证发件人是否为授权审核人"
}
```

### 申请状态检查
```json
{
  "type": "SharePointGetItems",
  "inputs": {
    "parameters": {
      "site": "@parameters('SharePointSiteUrl')",
      "list": "PermissionRequests",
      "query": {
        "filter": "RequestID eq '@{variables('ExtractedRequestID')}' and Status eq '已发送审批邮件'"
      }
    }
  },
  "description": "确认申请仍处于待审批状态"
}
```

### 重复处理防护
```json
{
  "type": "SharePointGetItems",
  "inputs": {
    "parameters": {
      "site": "@parameters('SharePointSiteUrl')",
      "list": "ApprovalHistory",
      "query": {
        "filter": "RequestID eq '@{variables('ExtractedRequestID')}' and ReviewerEmail eq '@{triggerBody()['From']}'"
      }
    }
  },
  "description": "检查该审核人是否已经审批过此申请"
}
```

## 6. 异常处理机制

### 解析失败处理
```json
{
  "type": "Condition",
  "expression": {
    "or": [
      "@empty(variables('ExtractedRequestID'))",
      "@equals(variables('DecisionConfidence'), 0)",
      "@empty(body('验证审核人身份')?['value'])"
    ]
  },
  "actions": {
    "发送解析失败通知": {
      "type": "Office365SendEmail",
      "inputs": {
        "parameters": {
          "To": "@triggerBody()['From']",
          "CC": "@parameters('SystemAdminEmail')",
          "Subject": "【系统提示】邮件审批格式不正确",
          "Body": "您的审批邮件格式不正确，请按照以下格式重新发送...",
          "IsHtml": true
        }
      }
    },
    "记录解析错误": {
      "type": "SharePointCreateItem",
      "inputs": {
        "parameters": {
          "site": "@parameters('SharePointSiteUrl')",
          "list": "EmailParsingErrors",
          "item": {
            "Title": "邮件解析失败",
            "SenderEmail": "@triggerBody()['From']",
            "Subject": "@triggerBody()['Subject']",
            "Body": "@triggerBody()['Body']",
            "ErrorReason": "@outputs('解析错误分析')",
            "ReceivedTime": "@utcNow()"
          }
        }
      }
    }
  }
}
```

### 模糊决策处理
```json
{
  "type": "Condition", 
  "expression": {
    "less": ["@variables('DecisionConfidence')", 0.7]
  },
  "actions": {
    "人工确认流程": {
      "type": "Office365SendEmail",
      "inputs": {
        "parameters": {
          "To": "@triggerBody()['From']",
          "Subject": "【需要确认】审批意见不够明确",
          "Body": "系统无法确定您的审批意见，请回复以下选项之一：\n1. 输入'APPROVE-@{variables('ExtractedRequestID')}'表示同意\n2. 输入'REJECT-@{variables('ExtractedRequestID')}'表示拒绝"
        }
      }
    },
    "标记待确认": {
      "type": "SharePointCreateItem",
      "inputs": {
        "parameters": {
          "site": "@parameters('SharePointSiteUrl')",
          "list": "PendingConfirmation",
          "item": {
            "RequestID": "@variables('ExtractedRequestID')",
            "ReviewerEmail": "@triggerBody()['From']",
            "OriginalContent": "@triggerBody()['Body']",
            "Confidence": "@variables('DecisionConfidence')",
            "Status": "待人工确认"
          }
        }
      }
    }
  }
}
```

## 7. 结果处理和更新

### 更新申请状态
```json
{
  "type": "SharePointUpdateItem",
  "inputs": {
    "parameters": {
      "site": "@parameters('SharePointSiteUrl')",
      "list": "PermissionRequests",
      "id": "@body('获取申请信息')?['value'][0]?['ID']",
      "item": {
        "Status": {
          "Value": "@if(equals(variables('FinalDecision'), 'APPROVE'), '审批通过', '审批拒绝')"
        },
        "ReviewDate": "@utcNow()",
        "Comments": "@variables('ExtractedComments')",
        "ReviewedBy": "@triggerBody()['From']"
      }
    }
  }
}
```

### 创建审批历史记录
```json
{
  "type": "SharePointCreateItem",
  "inputs": {
    "parameters": {
      "site": "@parameters('SharePointSiteUrl')",
      "list": "ApprovalHistory",
      "item": {
        "Title": "@concat(variables('ExtractedRequestID'), '-', formatDateTime(utcNow(), 'yyyyMMddHHmm'))",
        "RequestID": "@variables('ExtractedRequestID')",
        "ReviewerEmail": "@triggerBody()['From']",
        "Decision": "@variables('FinalDecision')",
        "Comments": "@variables('ExtractedComments')",
        "ReviewDate": "@utcNow()",
        "Source": "Email",
        "Confidence": "@variables('DecisionConfidence')",
        "OriginalSubject": "@triggerBody()['Subject']"
      }
    }
  }
}
```

## 8. 通知反馈机制

### 审批确认邮件
```json
{
  "type": "Office365SendEmail",
  "inputs": {
    "parameters": {
      "To": "@triggerBody()['From']",
      "CC": "@body('获取申请信息')?['value'][0]?['ApplicantEmail']",
      "Subject": "【审批确认】您的审批已处理 - @{variables('ExtractedRequestID')}",
      "Body": "感谢您的审批！\n申请编号：@{variables('ExtractedRequestID')}\n审批结果：@{if(equals(variables('FinalDecision'), 'APPROVE'), '同意', '拒绝')}\n处理时间：@{formatDateTime(utcNow(), 'yyyy年MM月dd日 HH:mm')}\n\n系统已自动更新申请状态。",
      "IsHtml": false
    }
  }
}
```

### 申请人结果通知
```json
{
  "type": "CallPowerAutomateFlow",
  "inputs": {
    "parameters": {
      "FlowName": "SendApprovalResultNotification",
      "RequestID": "@variables('ExtractedRequestID')",
      "Decision": "@variables('FinalDecision')",
      "Comments": "@variables('ExtractedComments')",
      "ReviewerName": "@body('获取审核人信息')?['value'][0]?['ReviewerName']"
    }
  }
}
```

## 9. 性能监控和统计

### 解析成功率统计
```json
{
  "type": "SharePointCreateItem",
  "inputs": {
    "parameters": {
      "site": "@parameters('SharePointSiteUrl')",
      "list": "EmailProcessingStats",
      "item": {
        "Title": "@formatDateTime(utcNow(), 'yyyyMMdd-HHmmss')",
        "ProcessingDate": "@utcNow()",
        "SenderEmail": "@triggerBody()['From']",
        "RequestID": "@variables('ExtractedRequestID')",
        "DecisionFound": "@variables('FinalDecision')",
        "Confidence": "@variables('DecisionConfidence')",
        "ProcessingTimeMs": "@sub(ticks(utcNow()), ticks(variables('StartTime')))",
        "Status": "Success"
      }
    }
  }
}
```

### 错误模式分析
```json
{
  "ErrorAnalytics": {
    "CommonFailureReasons": [
      "申请编号格式不正确",
      "决策关键词不明确", 
      "发件人非授权审核人",
      "申请已被处理",
      "邮件内容为空"
    ],
    "ImprovementSuggestions": [
      "更新邮件模板指导",
      "扩充关键词词典",
      "优化解析算法",
      "加强用户培训"
    ]
  }
}
```