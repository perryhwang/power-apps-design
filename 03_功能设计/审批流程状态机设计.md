# 审批流程状态机设计

## 状态机概览

### 核心状态定义
权限申请从创建到完成的完整生命周期状态管理

```
初始状态 → 待审批 → 审批中 → 最终状态
   ↓         ↓        ↓        ↓
 草稿    已发送审批邮件  收到反馈   通过/拒绝/超时
```

## 1. 状态定义和属性

### 主要状态枚举
```json
{
  "ApprovalStates": {
    "Draft": {
      "Code": "DRAFT",
      "Name": "草稿",
      "Description": "申请已创建但未提交",
      "Color": "#6C757D",
      "Icon": "Edit",
      "AllowedTransitions": ["Submitted", "Cancelled"]
    },
    "Submitted": {
      "Code": "SUBMITTED", 
      "Name": "已提交",
      "Description": "申请已提交，等待系统处理",
      "Color": "#007BFF",
      "Icon": "Upload",
      "AllowedTransitions": ["AssigningReviewer", "NoReviewer", "Cancelled"]
    },
    "AssigningReviewer": {
      "Code": "ASSIGNING",
      "Name": "分配审核人中",
      "Description": "系统正在匹配并分配审核人",
      "Color": "#FFC107",
      "Icon": "People",
      "AllowedTransitions": ["PendingApproval", "NoReviewer"]
    },
    "PendingApproval": {
      "Code": "PENDING",
      "Name": "待审批",
      "Description": "已发送给审核人，等待审批",
      "Color": "#FF8C00", 
      "Icon": "Clock",
      "AllowedTransitions": ["InReview", "Overdue", "Cancelled"]
    },
    "InReview": {
      "Code": "IN_REVIEW",
      "Name": "审批中",
      "Description": "审核人已开始处理",
      "Color": "#17A2B8",
      "Icon": "View",
      "AllowedTransitions": ["Approved", "Rejected", "NeedMoreInfo"]
    },
    "NeedMoreInfo": {
      "Code": "MORE_INFO",
      "Name": "需要补充信息",
      "Description": "审核人要求申请人提供更多信息",
      "Color": "#6F42C1",
      "Icon": "Help",
      "AllowedTransitions": ["InReview", "Cancelled", "Overdue"]
    },
    "Approved": {
      "Code": "APPROVED",
      "Name": "审批通过",
      "Description": "申请已被批准",
      "Color": "#28A745",
      "Icon": "CheckMark",
      "AllowedTransitions": ["Implemented", "Expired"],
      "IsFinalState": true
    },
    "Rejected": {
      "Code": "REJECTED",
      "Name": "审批拒绝", 
      "Description": "申请被拒绝",
      "Color": "#DC3545",
      "Icon": "Cancel",
      "AllowedTransitions": ["Resubmitted"],
      "IsFinalState": true
    },
    "Overdue": {
      "Code": "OVERDUE",
      "Name": "审批超时",
      "Description": "审批超过预定时间",
      "Color": "#E74C3C",
      "Icon": "Warning",
      "AllowedTransitions": ["InReview", "Escalated", "Cancelled"]
    },
    "Escalated": {
      "Code": "ESCALATED",
      "Name": "已升级",
      "Description": "超时申请已升级到上级审批",
      "Color": "#8E44AD",
      "Icon": "Up",
      "AllowedTransitions": ["Approved", "Rejected"]
    },
    "NoReviewer": {
      "Code": "NO_REVIEWER",
      "Name": "无匹配审核人",
      "Description": "系统未找到合适的审核人",
      "Color": "#FD7E14",
      "Icon": "ContactCard",
      "AllowedTransitions": ["ManualAssign", "Cancelled"]
    },
    "Cancelled": {
      "Code": "CANCELLED",
      "Name": "已取消",
      "Description": "申请已被取消",
      "Color": "#6C757D", 
      "Icon": "Delete",
      "AllowedTransitions": [],
      "IsFinalState": true
    },
    "Implemented": {
      "Code": "IMPLEMENTED",
      "Name": "已实施",
      "Description": "权限已实际分配给用户",
      "Color": "#20C997",
      "Icon": "Completed",
      "AllowedTransitions": ["Expired"],
      "IsFinalState": true
    },
    "Expired": {
      "Code": "EXPIRED",
      "Name": "已过期",
      "Description": "权限使用期限已过期",
      "Color": "#ADB5BD",
      "Icon": "Archive",
      "AllowedTransitions": [],
      "IsFinalState": true
    }
  }
}
```

### 状态属性扩展
```json
{
  "StateProperties": {
    "Metadata": {
      "EstimatedDuration": "预计停留时间(小时)",
      "RequiredActions": "该状态下需要的操作",
      "ResponsibleParty": "责任方",
      "NotificationRules": "通知规则",
      "SLATime": "服务水平协议时间"
    },
    "BusinessRules": {
      "AutoTransitionConditions": "自动状态转换条件",
      "ManualTransitionRequirements": "手动转换要求",
      "EscalationTriggers": "升级触发条件",
      "TimeoutHandling": "超时处理方式"
    }
  }
}
```

## 2. 状态转换规则

### 转换触发器定义
```json
{
  "StateTransitionTriggers": {
    "SystemAutomatic": {
      "Description": "系统自动触发",
      "Examples": [
        "数据导入完成 → 已提交",
        "找到审核人 → 待审批", 
        "超过时限 → 超时"
      ]
    },
    "UserAction": {
      "Description": "用户操作触发",
      "Examples": [
        "申请人取消 → 已取消",
        "审核人审批 → 通过/拒绝",
        "管理员手动分配 → 待审批"
      ]
    },
    "ExternalEvent": {
      "Description": "外部事件触发", 
      "Examples": [
        "邮件回复解析 → 审批中",
        "权限系统反馈 → 已实施",
        "定时任务检查 → 超时/过期"
      ]
    },
    "ConditionalLogic": {
      "Description": "条件逻辑判断",
      "Examples": [
        "多人审批全部同意 → 通过",
        "任意一人拒绝 → 拒绝",
        "部分审批超时 → 升级"
      ]
    }
  }
}
```

### 转换验证规则
```json
{
  "TransitionValidation": {
    "PreConditions": {
      "RequiredFields": ["RequestID", "CurrentStatus", "Applicant"],
      "BusinessLogicChecks": [
        "申请人身份有效性",
        "审核人权限验证",
        "申请内容完整性"
      ],
      "StateConsistencyChecks": [
        "当前状态与数据库一致",
        "转换路径合法性",
        "并发状态冲突检测"
      ]
    },
    "PostConditions": {
      "DataUpdates": [
        "更新状态时间戳",
        "记录状态变更历史",
        "更新相关统计数据"
      ],
      "NotificationTriggers": [
        "发送状态变更通知",
        "更新仪表板显示",
        "触发后续流程"
      ]
    }
  }
}
```

## 3. Power Automate状态管理流程

### 状态转换主流程
```json
{
  "FlowName": "ProcessStatusTransition",
  "Trigger": {
    "Type": "HTTPRequest",
    "Schema": {
      "RequestID": "string",
      "FromStatus": "string", 
      "ToStatus": "string",
      "TriggerSource": "string",
      "TriggerUser": "string",
      "AdditionalData": "object"
    }
  },
  "Steps": [
    {
      "Name": "ValidateTransition",
      "Type": "Condition",
      "Logic": "检查状态转换是否合法"
    },
    {
      "Name": "UpdateStatus",
      "Type": "SharePointUpdate", 
      "Target": "PermissionRequests"
    },
    {
      "Name": "LogStatusChange",
      "Type": "SharePointCreate",
      "Target": "StatusChangeHistory"
    },
    {
      "Name": "TriggerNotifications",
      "Type": "CallChildFlow"
    },
    {
      "Name": "ProcessPostActions",
      "Type": "Switch",
      "Cases": "根据目标状态执行不同操作"
    }
  ]
}
```

### 状态转换验证逻辑
```json
{
  "ValidationSteps": {
    "Step1_CheckCurrentStatus": {
      "Type": "SharePointGetItem",
      "Action": "获取当前申请状态",
      "Validation": "确认当前状态与请求中的FromStatus一致"
    },
    "Step2_ValidateTransitionPath": {
      "Type": "Compose",
      "Logic": "@contains(variables('StateDefinitions')[parameters('FromStatus')]['AllowedTransitions'], parameters('ToStatus'))"
    },
    "Step3_CheckUserPermissions": {
      "Type": "Condition",
      "Logic": "验证触发用户是否有权限执行此状态转换"
    },
    "Step4_BusinessRuleValidation": {
      "Type": "Switch",
      "Cases": {
        "ToApproved": "检查是否所有必要的审批已完成",
        "ToCancelled": "检查申请人或管理员权限",
        "ToEscalated": "验证超时条件和升级规则"
      }
    }
  }
}
```

## 4. 多审核人状态协调

### 并行审批状态管理
```json
{
  "ParallelApprovalLogic": {
    "ApprovalStrategy": "ALL_REQUIRED",
    "Options": {
      "ALL_REQUIRED": "所有审核人都必须同意",
      "ANY_SUFFICIENT": "任意一个审核人同意即可",
      "MAJORITY_RULE": "超过半数同意即通过",
      "WEIGHTED_VOTING": "按权重投票"
    },
    "StateCalculation": {
      "PendingCount": "待审批审核人数量",
      "ApprovedCount": "已同意审核人数量", 
      "RejectedCount": "已拒绝审核人数量",
      "OverdueCount": "超时审核人数量",
      "TotalCount": "总审核人数量"
    },
    "DecisionMatrix": {
      "AllApproved": "ApprovedCount == TotalCount → APPROVED",
      "AnyRejected": "RejectedCount > 0 → REJECTED", 
      "PartialTimeout": "OverdueCount > 0 && ApprovedCount + RejectedCount > 0 → ESCALATED",
      "AllTimeout": "OverdueCount == TotalCount → OVERDUE"
    }
  }
}
```

### 审核人状态跟踪表
```json
{
  "ReviewerStatusTracking": {
    "TableName": "ApprovalTracking",
    "Fields": {
      "RequestID": "申请编号",
      "ReviewerEmail": "审核人邮箱",
      "Status": "个人审批状态",
      "AssignedDate": "分配时间",
      "ResponseDate": "响应时间", 
      "Decision": "审批决定",
      "Comments": "审批意见",
      "IsOverdue": "是否超时"
    },
    "StatusValues": [
      "Assigned", "InProgress", "Approved", "Rejected", "Overdue", "Skipped"
    ]
  }
}
```

## 5. 自动状态转换规则

### 定时检查流程
```json
{
  "ScheduledStatusCheck": {
    "Trigger": {
      "Type": "Recurrence",
      "Frequency": "Hour",
      "Interval": 1
    },
    "CheckList": [
      {
        "Name": "OverdueCheck",
        "Query": "状态为'待审批'且分配时间超过SLA时限",
        "Action": "转换为'超时'状态"
      },
      {
        "Name": "EscalationCheck", 
        "Query": "超时状态持续超过升级时限",
        "Action": "转换为'已升级'状态并分配上级审核人"
      },
      {
        "Name": "ExpirationCheck",
        "Query": "已实施权限超过有效期",
        "Action": "转换为'已过期'状态"
      },
      {
        "Name": "AbandonedCheck",
        "Query": "长期无响应的申请",
        "Action": "自动取消或归档"
      }
    ]
  }
}
```

### SLA时间配置
```json
{
  "SLAConfiguration": {
    "ApprovalTimeouts": {
      "StandardRequest": {
        "PendingToOverdue": "72小时",
        "OverdueToEscalated": "24小时"
      },
      "UrgentRequest": {
        "PendingToOverdue": "24小时", 
        "OverdueToEscalated": "8小时"
      },
      "CriticalRequest": {
        "PendingToOverdue": "8小时",
        "OverdueToEscalated": "2小时"
      }
    },
    "ImplementationTimeouts": {
      "ApprovedToImplemented": "5个工作日",
      "ImplementedToExpired": "根据申请期限"
    }
  }
}
```

## 6. 状态变更通知机制

### 通知规则配置
```json
{
  "NotificationRules": {
    "StateChangeNotifications": {
      "ToApplicant": {
        "Statuses": ["Submitted", "PendingApproval", "Approved", "Rejected", "NeedMoreInfo"],
        "Template": "ApplicantStatusUpdate",
        "Delay": "立即发送"
      },
      "ToReviewer": {
        "Statuses": ["PendingApproval", "Overdue"],
        "Template": "ReviewerNotification", 
        "Delay": "立即发送"
      },
      "ToAdmin": {
        "Statuses": ["NoReviewer", "Escalated", "SystemError"],
        "Template": "AdminAlert",
        "Delay": "立即发送"
      }
    },
    "PeriodicReminders": {
      "PendingApproval": {
        "FirstReminder": "24小时后",
        "SecondReminder": "48小时后",
        "FinalReminder": "超时前2小时"
      },
      "NeedMoreInfo": {
        "Reminder": "每48小时提醒申请人"
      }
    }
  }
}
```

### 通知内容个性化
```json
{
  "NotificationTemplates": {
    "ApplicantStatusUpdate": {
      "Approved": {
        "Subject": "好消息！您的权限申请已获批准",
        "Priority": "Normal",
        "Actions": ["查看详情", "确认接收"]
      },
      "Rejected": {
        "Subject": "权限申请审批结果通知",
        "Priority": "Normal", 
        "Actions": ["查看原因", "重新申请"]
      },
      "NeedMoreInfo": {
        "Subject": "权限申请需要补充信息",
        "Priority": "High",
        "Actions": ["补充信息", "联系审核人"]
      }
    }
  }
}
```

## 7. 状态统计和分析

### 状态持续时间分析
```json
{
  "StatusAnalytics": {
    "Queries": {
      "AverageProcessingTime": {
        "SQL": "SELECT AVG(DATEDIFF(hour, SubmittedDate, CompletedDate)) FROM PermissionRequests WHERE Status IN ('Approved', 'Rejected')",
        "Purpose": "平均处理时间"
      },
      "StatusDistribution": {
        "SQL": "SELECT Status, COUNT(*) as Count FROM PermissionRequests GROUP BY Status",
        "Purpose": "当前状态分布"
      },
      "TimeoutRate": {
        "SQL": "SELECT (SELECT COUNT(*) FROM PermissionRequests WHERE Status = 'Overdue') * 100.0 / COUNT(*) FROM PermissionRequests WHERE Status != 'Draft'",
        "Purpose": "超时率计算"
      }
    }
  }
}
```

### 状态转换热力图
```json
{
  "TransitionHeatmap": {
    "DataSource": "StatusChangeHistory",
    "Dimensions": {
      "FromStatus": "源状态",
      "ToStatus": "目标状态", 
      "TransitionCount": "转换次数",
      "AverageTime": "平均转换时间"
    },
    "Visualizations": [
      "状态转换频率矩阵",
      "异常转换路径识别",
      "瓶颈状态分析"
    ]
  }
}
```

## 8. 错误恢复和一致性保障

### 状态一致性检查
```json
{
  "ConsistencyCheck": {
    "ScheduledValidation": {
      "Frequency": "每小时", 
      "Checks": [
        "申请状态与审核人状态一致性",
        "时间戳逻辑合理性",
        "状态转换路径合法性",
        "孤立状态记录检测"
      ]
    },
    "AutoRepair": {
      "Enabled": true,
      "RepairActions": [
        "重新同步状态",
        "修复时间戳错误",
        "清理孤立记录",
        "发送管理员警告"
      ]
    }
  }
}
```

### 状态回滚机制
```json
{
  "RollbackSupport": {
    "Conditions": [
      "系统错误导致的错误状态转换",
      "用户误操作",
      "数据一致性问题"
    ],
    "RollbackProcess": [
      "验证回滚权限",
      "检查回滚影响范围", 
      "执行状态恢复",
      "记录回滚日志",
      "发送相关通知"
    ],
    "Limitations": [
      "不能回滚已实施的权限",
      "不能回滚超过7天的状态",
      "需要管理员授权"
    ]
  }
}
```